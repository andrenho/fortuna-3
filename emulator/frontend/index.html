<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=yes, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Fortuna-3 emulator</title>
</head>

<!---- GLOBALS ---->
<script>
    $ = (name) => document.getElementById(name)
    $$ = (name) => Array.from(document.getElementsByClassName(name))

    hex = (value, pad=2, withPrefix=false) => (withPrefix ? "0x" : "") + value.toString(16).padStart(pad, '0');
</script>

<!---- EMULATOR ---->
<script>

    class Emulator {

        ram = new Uint8Array();
        sp = 0;

        constructor(memorySize = (64 * 1024)) {
            this.memorySize = memorySize;
            this.ram = new Uint8Array(memorySize);
            for (let i = 0; i < memorySize; ++i)
                this.ram[i] = Math.random() * 256;
        }

        getRamByte(addr) {
            while (addr < 0)
                addr += this.memorySize;
            return this.ram[addr & (this.memorySize - 1)];
        }

        getRamWord(addr) {
            return this.getRamByte(addr) | (this.getRamByte(addr + 1) << 8);
        }

        stack(length) {
            let current = 0;
            let values = [];
            for (let i = 0; i < length; ++i) {
                values.push(this.getRamWord(current));
                current -= 2;
            }
            return values;
        }

    }

</script>

<!---- COMPONENT - COMMAND-BUTTON ---->
<template id="command-button-template">

    <style>
        .buttons {
            position: fixed;
            top: 0;
            right: 0;
            border-left: 2px solid black;
            border-bottom: 2px solid black;
            padding: 12px;
            background: white;
        }
    </style>

    <div class="buttons">
        <button id="step" title="Step one instruction" style="letter-spacing: -1px;">&#x25B6;||</button>
    </div>

</template>
<script>
    window.customElements.define("command-button", class extends HTMLElement {

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("command-button-template").content.cloneNode(true));

            const step = this.shadowRoot.getElementById("step");
            step.addEventListener("click", () => this.dispatchEvent(new CustomEvent("step", {
                bubbles: true, composed: true, detail: "composed"
            })));
        }

    });
</script>

<!---- COMPONENT - TABS ---->
<template id="tab-main-template">

    <style>
        .tabs {
            display: flex;
            flex-direction: row;
            white-space: nowrap;
        }

        .tab-start {
            border-bottom: 1px black solid;
            width: 24px;
        }

        .tab-end {
            border-bottom: 1px black solid;
            width: 100%;
        }
    </style>

    <div class="tabs">
        <div class="tab-start"></div>
        <slot></slot>
        <div class="tab-end"></div>
    </div>

</template>
<template id="tab-item-template">

    <style>

        :host {
            display: flex;
        }

        .tab {
            border: 1px black solid;
            padding: 6px 14px;
            cursor: pointer;
            background-color: lightgray;
        }

        .tab-middle {
            border-bottom: 1px black solid;
            width: 12px;
        }

        .tab-selected {
            background: white;
            border-bottom: 0;
        }

    </style>

    <div id="tab" class="tab"><slot></slot></div>
    <div class="tab-middle"></div>
</template>
<script>

    window.addEventListener("load", () => {

        window.customElements.define("tab-main", class extends HTMLElement {

            constructor() {
                super();
                this.attachShadow({ mode: "open" })
                this.shadowRoot.appendChild($("tab-main-template").content.cloneNode(true));
            }

            unselectAll(except) {
                this.querySelectorAll("tab-item").forEach(element => {
                    if (element !== except)
                        element.removeAttribute("selected");
                });
            }

        });

        window.customElements.define("tab-item", class extends HTMLElement {

            constructor() {
                super();
                this.attachShadow({ mode: "open" })
                this.shadowRoot.appendChild($("tab-item-template").content.cloneNode(true));
                this.tabElement = this.shadowRoot.getElementById("tab");
                if (!this.getAttribute("selected"))
                    this.unselectTab();
                this.tabElement.addEventListener("click", () => {
                    this.parentElement.unselectAll();
                    this.setAttribute("selected", "selected");
                });
            }

            static get observedAttributes() { return ['selected']; }

            attributeChangedCallback(prop, old, newValue) {
                if (prop === 'selected') {
                    if (newValue === null)
                        this.unselectTab();
                    else
                        this.selectTab();
                }
            }

            selectTab() {
                const elementToChange = this.getAttribute("for");
                this.tabElement.classList.add("tab-selected");
                if (elementToChange)
                    $(elementToChange).style.display = "block";
            }

            unselectTab() {
                const elementToChange = this.getAttribute("for");
                this.tabElement.classList.remove("tab-selected");
                if (elementToChange)
                    $(elementToChange).style.display = "none";
            }

        });

    });

</script>

<!---- COMPONENT - FLAT-DATA ---->
<template id="flat-data-template">

    <style>
        * { font-family: ShareTech, monospace; }

        .main {
            border: 1px solid black;
            padding: 16px;
            width: fit-content;
        }

        .title-row {
            display: flex;
            gap: 4px;
            align-items: baseline;
            margin-bottom: 24px;
        }

        .title {
            font-weight: bold;
            width: 200px;
        }

        .space-after {
            width: 22px;
            padding-right: 12px;
        }

        .address {
            font-weight: bold;
        }

        .data {
            text-align: center;
        }

        .error {
            background-color: lightcoral;
        }

        .highlighted {
            background-color: mediumspringgreen;
        }

        input { font-size: medium; }
        button { font-size: medium; }
        th {
            width: 22px;
            vertical-align: top;
        }
    </style>

    <div class="main">
        <div class="title-row">
            <div id="title" class="title">Title here</div>
            <label for="page">Page:</label>
            <button id="previous-page" title="Previous page">&lt;&lt;</button>
            <input id="page" type="text" size="6" value="0x0" style="text-align: right;">
            <button id="next-page" title="Next page">&gt;&gt;</button>
        </div>

        <table style="table-layout: fixed; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 54px; height: 28px;"></th>
                    <th>_0</th><th>_1</th><th>_2</th><th>_3</th><th>_4</th><th>_5</th><th>_6</th><th class="space-after">_7</th>
                    <th>_8</th><th>_9</th><th>_a</th><th>_b</th><th>_c</th><th>_d</th><th>_e</th><th class="space-after">_f</th>
                    <th style="width: 150px; text-align: left;">ASCII</th>
                </tr>
            </thead>
            <tbody id="data-table"></tbody>
        </table>

        <slot></slot>
    </div>

</template>
<script>

    window.customElements.define("flat-data", class extends HTMLElement {

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("flat-data-template").content.cloneNode(true));

            this.dataFetchCallback_ = undefined;
            this.highlightAddress = undefined;

            this.shadowRoot.getElementById("previous-page").addEventListener("click", () => this.#updatePage(-1));
            this.shadowRoot.getElementById("next-page").addEventListener("click", () => this.#updatePage(+1));
            this.shadowRoot.getElementById("page").addEventListener("input", (e) => this.#setPage(e.currentTarget.value));
            this.shadowRoot.getElementById("page").addEventListener("change", (e) => this.#updatePageInput());
        }

        connectedCallback() {
            this.page = parseInt(this.getAttribute("page") || 0);
            this.maxPages = parseInt(this.getAttribute("max-page"));
            this.rows = parseInt(this.getAttribute("rows"));
            this.shadowRoot.getElementById("title").innerText = this.getAttribute("title");

            let tbody = [];
            for (let row = 0; row < this.rows; ++row) {
                tbody.push(`<tr><td class="address" id="address_${row}">0000</td>`);
                for (let column = 0; column < 16; ++column)
                    tbody.push(`<td class="data ${(column === 7 || column === 15) ? "space-after" : ""}" id="data_${row}_${column}">00</td>`);
                tbody.push(`<td class="data" id="ascii_${row}">........ ........</td></tr>`);
            }
            this.shadowRoot.getElementById("data-table").innerHTML = tbody.join('');
        }

        set dataFetchCallback(d) {
            this.dataFetchCallback_ = d;
            this.update();
        }

        #updatePage(step) {
            if (isNaN(this.page)) {
                this.page = 0;
                this.shadowRoot.getElementById("page").classList.remove("error");
            } else {
                this.page += step;
                if (this.page < 0)
                    this.page = (this.maxPages - 1);
                if (this.page >= this.maxPages)
                    this.page = 0;
            }
            this.setAttribute("current-page", this.page);
        }

        #setPage(pageStr) {
            this.page = parseInt(pageStr, 16);
            if (isNaN(this.page) || this.page < 0 || this.page >= this.maxPages) {
                this.shadowRoot.getElementById("page").classList.add("error");
                this.page = NaN;
            } else {
                this.shadowRoot.getElementById("page").classList.remove("error");
            }
            this.update(false);
        }

        update(updateElement = true) {
            if (updateElement)
                this.#updatePageInput();

            if (isNaN(this.page))
                this.#updateTableAsError();
            else if (this.dataFetchCallback_)
                this.#updateTable();

            console.debug("flat-data updated");
        }

        #updatePageInput() {
            if (!isNaN(this.page))
                this.shadowRoot.getElementById("page").value = hex(this.page, 0, true);
        }

        #updateTable() {
            const data = this.dataFetchCallback_(this.page * this.rows * 16, this.rows * 16);
            for (let row = 0; row < this.rows; ++row) {
                let addr = (this.page * this.rows * 16) + (row * 16);
                this.shadowRoot.getElementById(`address_${row}`).innerText = hex(addr, 4);
                let ascii = [];
                for (let column = 0; column < 16; ++column) {
                    let i = (row * 16) + column;
                    const element = this.shadowRoot.getElementById(`data_${row}_${column}`);
                    element.innerText = hex(data[i]);
                    if (this.highlightAddress === (addr + column))
                        element.classList.add("highlighted");
                    else
                        element.classList.remove("highlighted");
                    ascii.push((data[i] < 32 || data[i] > 126) ? '.' : String.fromCharCode(data[i]));
                }
                this.shadowRoot.getElementById(`ascii_${row}`).innerText = ascii.join('');
            }
        }

        #updateTableAsError() {
            for (let row = 0; row < this.rows; ++row) {
                this.shadowRoot.getElementById(`address_${row}`).innerText = "XXXX";
                for (let column = 0; column < 16; ++column) {
                    const element = this.shadowRoot.getElementById(`data_${row}_${column}`);
                    element.classList.remove("highlighted");
                    element.innerText = "XX";
                }
                this.shadowRoot.getElementById(`ascii_${row}`).innerText = "xxxxxxxx xxxxxxxx";
            }
        }

        static get observedAttributes() {
            return ['current-page', 'highlight-address'];
        }

        attributeChangedCallback(prop, old, newValue) {
            if (prop === 'current-page') {
                this.page = parseInt(newValue);
            } else if (prop === 'highlight-address') {
                this.highlightAddress = parseInt(newValue);
            }
            this.update();
        }

    });

</script>

<!---- COMPONENT - STACK ---->
<template id="memory-stack-template">

    <style>
        .main {
            padding-top: 12px;
            display: grid;
            grid-template-columns: auto auto;
            grid-template-rows: auto auto;
            justify-content: start;
        }

        .title {
            font-weight: bold;
            padding-right: 12px;
        }

        .arrow {
            grid-column: 2;
            font-weight: bold;
            font-size: 10px;
        }
    </style>

    <div class="main">
        <div class="title">Stack:</div>
        <div class="values"><span id="data"></span></div>
        <div class="arrow">PUSH <span style="letter-spacing: -2px;">--&gt;</span></div>
    </div>

</template>
<script>

    window.customElements.define("memory-stack", class extends HTMLElement {

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("memory-stack-template").content.cloneNode(true));
            this.stackFetchCallback_ = undefined;
        }

        set stackFetchCallback(d) {
            this.stackFetchCallback_ = d;
            this.update();
        }

        connectedCallback() {
            this.length = parseInt(this.getAttribute("length"));
            this.update();
        }

        update() {
            if (this.stackFetchCallback_ && this.length) {
                this.shadowRoot.getElementById("data").innerText = this.stackFetchCallback_(this.length)
                    .map((v) => hex(v, 4))
                    .join(' ');
            }
            console.debug("memory-stack updated");
        }

    });

</script>

<!---- COMPONENT - DEBUG-CODE ---->
<template id="debug-code-template">

    <style>
        .main {
            display: flex;
        }

		.files {
			display: flex;
			flex-direction: column;
			width: 150px;
		}

		.file {
			font-size: 14px;
			border: 1px black solid;
			border-right: 0;
			border-bottom: 0;
			padding: 2px 8px;
			cursor: pointer;
		}

		.file:last-child {
			border-bottom: 1px black solid;
		}

		.selected {
			background: aquamarine;
		}

        .code {
            border: 1px black solid;
            border-collapse: collapse;
            table-layout: fixed;
			min-height: 500px;
        }

        td {
            border: 0;
            padding-right: 8px;
            padding-left: 8px;
        }

        .breakpoint {
            width: 12px;
            border-right: 1px black solid;
			cursor: pointer;
        }

        .address {
            width: 35px;
            border-right: 1px black solid;
        }

        .line {
            width: 500px;
            overflow-x: hidden;
            white-space: nowrap;
        }

        .bytes {
            border-left: 1px black solid;
			width: 150px;
        }

        .comment {
            color: forestgreen;
        }

        .current {
            background-color: yellow;
        }

        .active {
            background-color: crimson !important;
        }

		.last-line {
			height: 100%;
		}
    </style>

    <div class="main">
        <div class="files">
			<div class="file">main.s</div>
			<div class="file selected">temp_file.s</div>
        </div>
        <table class="code">
            <tr>
                <td class="breakpoint active"></td>
                <td class="address">0000</td>
                <td class="line">hello <span class="comment">; this is a comment</span></td>
                <td class="bytes">FA 44 38</td>
            </tr>
            <tr>
                <td class="breakpoint current"></td>
                <td class="address current">0000</td>
                <td class="line current">&nbsp;&nbsp;&nbsp;&nbsp;nop</td>
                <td class="bytes current">FA 44 38</td>
            </tr>
            <tr>
                <td class="breakpoint last-line"></td>
                <td class="address last-line"></td>
                <td class="line last-line"></td>
                <td class="bytes last-line"></td>
            </tr>
        </table>
    </div>

</template>
<script>

    window.customElements.define("debug-code", class extends HTMLElement {

        #debugCode;

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("debug-code-template").content.cloneNode(true));
        }

        setDebugCode(debugCode) {
            this.#debugCode = debugCode;
        }

    });

</script>

<!---- CSS - STYLE ---->
<style>
    @font-face { font-family: ShareTech; src: url('ShareTechMono-Regular.ttf'); }

    html { font-family: ShareTech, monospace; }
    button { font-family: ShareTech, monospace; }
    input { font-family: ShareTech, monospace; }

    .main { padding: 32px; }

</style>

<!---- HTML - BODY ---->
<body>

    <command-button id="command-button"></command-button>

    <tab-main>
        <tab-item for="emulator-panel" selected>Emulator</tab-item>
        <tab-item for="sdcard-panel">SD Card</tab-item>
    </tab-main>

    <div id="emulator-panel">
        <div class="main">
            <!--
            <flat-data id="ram" title="Memory (RAM)" current-page="0" max-page="256" rows="16" highlight-address="258">
                <memory-stack id="stack" length="12"></memory-stack>
            </flat-data>
            -->
            <debug-code id="debug-code"></debug-code>
        </div>
    </div>

    <div id="sdcard-panel">SD Card</div>

</body>

<!---- INITIALIZATION ---->
<script>

    window.addEventListener("load", () => {
        const emulator = new Emulator();

        /*
        $("ram").dataFetchCallback = (initialAddr, pageSize) => new Uint8Array(emulator.ram.buffer.slice(initialAddr, initialAddr + pageSize));
        $("stack").stackFetchCallback = (length) => emulator.stack(length);
         */

        $("debug-code").setDebugCode({
            "main.z80": "    nop\n    jmp hello  ; jump to hello.z80",
            "hello.z80": "    nop\nhello:\n    nop\n    ret"
        });

    });

</script>

</html>

<!-- vim: foldmethod=indent:ts=4:sts=4:sw=4:noexpandtab
-->
