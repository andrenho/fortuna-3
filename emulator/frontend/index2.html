<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=yes, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Fortuna-3 emulator</title>
</head>

<!---- GLOBALS ---->
<script>
    $ = (name) => document.getElementById(name)
    $$ = (name) => Array.from(document.getElementsByClassName(name))
</script>

<!---- COMPONENT - COMMAND-BUTTON ---->
<template id="command-button-template">

    <style>
        .buttons {
            position: fixed;
            top: 0;
            right: 0;
            border-left: 2px solid black;
            border-bottom: 2px solid black;
            padding: 12px;
            background: white;
        }
    </style>

    <div class="buttons">
        <button id="step" title="Step one instruction" style="letter-spacing: -1px;">&#x25B6;||</button>
    </div>

</template>
<script>
    window.customElements.define("command-button", class extends HTMLElement {

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("command-button-template").content.cloneNode(true));

            const step = this.shadowRoot.getElementById("step");
            step.addEventListener("click", () => this.dispatchEvent(new CustomEvent("step", {
                bubbles: true, composed: true, detail: "composed"
            })));
        }

    });
</script>

<!---- COMPONENT - TABS ---->
<template id="tab-main-template">

    <style>
        .tabs {
            display: flex;
            flex-direction: row;
            white-space: nowrap;
        }

        .tab-start {
            border-bottom: 1px black solid;
            width: 24px;
        }

        .tab-end {
            border-bottom: 1px black solid;
            width: 100%;
        }
    </style>

    <div class="tabs">
        <div class="tab-start"></div>
        <slot></slot>
        <div class="tab-end"></div>
    </div>

</template>
<template id="tab-item-template">

    <style>

        :host {
            display: flex;
        }

        .tab {
            border: 1px black solid;
            padding: 6px 14px;
            cursor: pointer;
            background-color: lightgray;
        }

        .tab-middle {
            border-bottom: 1px black solid;
            width: 12px;
        }

        .tab-selected {
            background: white;
            border-bottom: 0;
        }

    </style>

    <div id="tab" class="tab"><slot></slot></div>
    <div class="tab-middle"></div>
</template>
<script>

    window.addEventListener("load", () => {

        window.customElements.define("tab-main", class extends HTMLElement {

            constructor() {
                super();
                this.attachShadow({ mode: "open" })
                this.shadowRoot.appendChild($("tab-main-template").content.cloneNode(true));
            }

            unselectAll(except) {
                this.querySelectorAll("tab-item").forEach(element => {
                    if (element !== except)
                        element.removeAttribute("selected");
                });
            }

        });

        window.customElements.define("tab-item", class extends HTMLElement {

            constructor() {
                super();
                this.attachShadow({ mode: "open" })
                this.shadowRoot.appendChild($("tab-item-template").content.cloneNode(true));
                this.tabElement = this.shadowRoot.getElementById("tab");
                if (!this.getAttribute("selected"))
                    this.unselectTab();
                this.tabElement.addEventListener("click", () => {
                    this.parentElement.unselectAll();
                    this.setAttribute("selected", "selected");
                });
            }

            static get observedAttributes() { return ['selected']; }

            attributeChangedCallback(prop, old, newValue) {
                if (prop === 'selected') {
                    if (newValue === null)
                        this.unselectTab();
                    else
                        this.selectTab();
                }
            }

            selectTab() {
                const elementToChange = this.getAttribute("for");
                this.tabElement.classList.add("tab-selected");
                if (elementToChange)
                    $(elementToChange).style.display = "block";
            }

            unselectTab() {
                const elementToChange = this.getAttribute("for");
                this.tabElement.classList.remove("tab-selected");
                if (elementToChange)
                    $(elementToChange).style.display = "none";
            }

        });

    });

</script>

<!---- COMPONENT - FLAT-DATA ---->
<template id="flat-data-template">

    <style>
        * { font-family: ShareTech, monospace; }

        .main {
            border: 1px solid black;
            padding: 16px;
            width: fit-content;
        }

        .title-row {
            display: flex;
            gap: 4px;
            align-items: baseline;
            margin-bottom: 24px;
        }

        .title {
            font-weight: bold;
            width: 200px;
        }

        input { font-size: medium; }
        button { font-size: medium; }
        th {
            text-align: left;
            width: 22px;
        }
    </style>

    <div class="main">
        <div class="title-row">
            <div id="title" class="title">Title here</div>
            <label for="page">Page:</label>
            <button id="previous-page" title="Previous page">&lt;&lt;</button>
            <input id="page" type="text" size="6" value="0x0" style="text-align: right;">
            <button id="next-page" title="Next page">&gt;&gt;</button>
        </div>

        <table style="table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 48px;"></th>
                    <th>_0</th><th>_1</th><th>_2</th><th>_3</th><th>_4</th><th>_5</th><th>_6</th><th>_7</th>
                    <th style="width: 10px;"></th>
                    <th>_8</th><th>_9</th><th>_A</th><th>_B</th><th>_C</th><th>_D</th><th>_E</th><th>_F</th>
                    <th></th>
                    <th style="width: 90px;">ASCII</th>
                </tr>
            </thead>
            <tbody id="data-table"></tbody>
        </table>

        <span></span>
    </div>

</template>
<script>

    window.customElements.define("flat-data", class extends HTMLElement {

        // page, previous-page, next-page, data-table
        // <flat-data id="ram" title="RAM" current-page="0" max-page="256" rows="16"></flat-data>

        constructor() {
            super();
            this.attachShadow({ mode: "open" })
            this.shadowRoot.appendChild($("flat-data-template").content.cloneNode(true));

            this.shadowRoot.getElementById("previous-page").addEventListener("click", () => this.previousPage());
            this.shadowRoot.getElementById("next-page").addEventListener("click", () => this.nextPage());
        }

        connectedCallback() {
            this.page = parseInt(this.getAttribute("page") || 0);
            this.maxPages = parseInt(this.getAttribute("max-page"));
            this.rows = parseInt(this.getAttribute("rows"));
            this.shadowRoot.getElementById("title").innerText = this.getAttribute("title");
        }

        previousPage() {
            this.page--;
            if (this.page < 0)
                this.page = (this.maxPages - 1);
            this.setAttribute("current-page", this.page);
        }

        nextPage() {
            this.page++;
            if (this.page >= this.maxPages)
                this.page = 0;
            this.setAttribute("current-page", this.page);
        }

        onPageUpdate() {
            this.shadowRoot.getElementById("page").value = `0x${this.page.toString(16).toUpperCase()}`;
        }

        static get observedAttributes() {
            return ['current-page'];
        }

        attributeChangedCallback(prop, old, newValue) {
            if (prop === 'current-page') {
                this.page = parseInt(newValue);
                this.onPageUpdate();
            }
        }

        setData(data) {
        }

    });

</script>

<!---- CSS - STYLE ---->
<style>
    @font-face { font-family: ShareTech; src: url('ShareTechMono-Regular.ttf'); }

    html { font-family: ShareTech, monospace; }
    button { font-family: ShareTech, monospace; }
    input { font-family: ShareTech, monospace; }

    .main { padding: 32px; }

</style>

<!---- HTML - BODY ---->
<body>

    <command-button id="command-button"></command-button>

    <tab-main>
        <tab-item for="emulator-panel" selected>Emulator</tab-item>
        <tab-item for="sdcard-panel">SD Card</tab-item>
    </tab-main>

    <div id="emulator-panel">
        <div class="main">
            <flat-data id="ram" title="Memory (RAM)" current-page="0" max-page="256" rows="16"></flat-data>
        </div>
    </div>

    <div id="sdcard-panel">SD Card</div>

</body>

<!---- INITIALIZATION ---->
<script>

    window.addEventListener("load", () => {
        $("command-button").addEventListener("step", (e) => console.log(e));
    });

</script>

</html>